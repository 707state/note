# 数据库

1. 如何设计一个高效的多线程并发执行框架来优化查询和数据导入？
回答：

    采用 线程池 来管理工作线程，避免频繁创建和销毁线程的开销。
    使用 任务队列（如基于 std::queue 或 lock-free queue）来调度任务，并支持工作窃取 (work stealing) 提高 CPU 利用率。
    读写操作采用 读写锁（RWLock），对读操作加共享锁，提高查询并发度，而写操作加独占锁，保证数据一致性。
    数据导入时，可将任务拆分为多个小批次，在多个线程间 并行执行，减少等待时间。

2. B+树索引相比于普通 B 树的优势是什么？为什么数据库更倾向于使用 B+树？
回答：

    B+树的叶子节点存储所有数据，内部节点只存索引，提高了范围查询和顺序访问的效率，而 B 树的所有节点都存数据，导致遍历时需要逐层遍历。
    B+树的范围查询更快，因为叶子节点使用 链表结构 串联，支持 O(1) 复杂度的顺序访问。
    减少 I/O 操作，B+树的内部节点不存实际数据，使得 每个节点能存更多索引项，降低树的高度，减少磁盘访问次数。
    支持覆盖索引，查询可以直接从索引读取数据，无需访问数据页，提高查询性能。

3. 数据库如何保证索引的事务一致性？
回答：

    索引也是数据的一部分，需要纳入事务管理中，通常采用 WAL（Write-Ahead Logging）+ MVCC 机制保证一致性。
    事务操作索引时：
        插入时，需要在事务提交前写入 Redo Log 和 Undo Log，确保崩溃恢复时索引状态正确。
        删除索引项时，使用 标记删除（Lazy Deletion），待事务提交后再清理，避免未提交事务访问无效索引项。
        更新索引时，事务回滚需要能撤销索引变更，因此 Undo Log 必须记录索引的原始状态。
    加锁控制：
        采用 意向锁（Intention Lock），在操作索引页时，确保不会有其他事务并发修改同一节点。
        GAP Lock 解决范围查询的幻读问题，确保插入不会破坏一致性。

4. WAL 日志如何提高数据库的持久化性能？Redo 和 Undo 的作用是什么？
回答：

    WAL（Write-Ahead Logging） 机制确保数据在写入磁盘前，先写入日志，提高事务的可靠性。
    Redo Log（重做日志）：
        记录 事务提交后的变更，在数据库崩溃后可用于 重做已提交事务，确保数据不丢失。
        Redo 日志通常采用 顺序写入，减少随机 I/O，提升性能。
    Undo Log（撤销日志）：
        记录 事务未提交前的原始数据，当事务回滚时可以 撤销未提交的变更，确保一致性。
        Undo Log 也用于 MVCC，支持多版本并发控制。
    Checkpoint 机制：
        定期将 WAL 中的变更应用到数据库页，并截断已持久化的日志，减少 WAL 体积，提高恢复速度。

5. 如何优化批量数据导入的性能，使百万级数据导入时间缩短至 10 分钟以内？
回答：

    分批导入（Batch Insert）：
        使用 批量提交（Bulk Insert） 方式，一次写入多个数据，减少事务提交的开销。
    并行数据加载：
        使用 多线程并行写入，拆分数据块，每个线程负责导入一部分数据，避免单线程写入瓶颈。
    索引优化：
        导入前 暂时禁用索引，批量导入数据后再 批量重建索引，减少插入时的索引维护开销。
        增量索引构建：避免每次插入都更新索引，而是在批量导入后，一次性重新构建索引。
    事务优化：
        调整 事务提交策略，避免每条记录都触发 COMMIT，可以每 10 万条数据提交一次，减少事务管理的负担。
    日志优化：
        关闭 WAL 日志 或 使用异步 WAL，减少 I/O 开销，待数据导入完成后再开启 WAL 以确保数据安全。

6. 如何进行数据库崩溃恢复？恢复过程是怎样的？
回答：

数据库崩溃恢复一般依赖于 WAL 机制，恢复流程如下：

    分析阶段（Analysis Phase）：
        读取 WAL 日志，检查哪些事务是提交的，哪些是未完成的。
    重做阶段（Redo Phase）：
        对于已提交的事务，按照 Redo Log 进行 重放（Replay），确保数据状态恢复到最新。
    撤销阶段（Undo Phase）：
        对于未提交的事务，利用 Undo Log 进行 回滚（Rollback），恢复数据到事务开始前的状态。
    Checkpoint 机制：
        通过 Checkpoint，减少需要重放的日志数量，加快恢复速度。

7. TPC-C 测试的主要评测指标是什么？数据库如何优化 TPC-C 事务处理性能？
回答：

TPC-C 主要评测数据库的 事务处理能力（tpmC, transactions per minute C），主要优化点包括：

    事务优化：
        采用 短事务，减少事务持有的锁时间，提高吞吐量。
        使用 存储过程 预编译 SQL 语句，减少解析和优化时间。
    索引优化：
        针对 库存查询、订单查询 等高频操作使用覆盖索引，减少回表操作。
    锁优化：
        采用 行锁（Row Lock） 代替表锁，减少锁冲突。
        使用 乐观锁 代替悲观锁，减少锁等待时间。
    缓存机制：
        利用 LRU 缓存最近访问的数据，减少磁盘 I/O，提升查询速度。
