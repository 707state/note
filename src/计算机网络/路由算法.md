<!--toc:start-->
- [OSPF开放式最短路径优先](#ospf开放式最短路径优先)
<!--toc:end-->

# OSPF开放式最短路径优先

这是一个基于链路状态的内部网关协议（IGP），广泛应用于大型网络中。OSPF使用Dijkstra算法来计算网络的最短路径，并且能够快速收敛，适用于各种规模的网络。

OSPF是一种基于IP协议的路由协议。它是大中型网络上使用较为广泛的IGP协议。OSPF是对链路状态路由协议的一种实现，运作于自治系统内部。OSPF分为OSPFv2和OSPFv3两个版本：OSPFv2定义于RFC 2328（1998），支持IPv4网络；而OSPFv3定义于RFC 5340（2008），支持IPv6网络。

它采用戴克斯特拉算法来计算最短路径树。它使用“开销（Cost）”作为路由度量。链路状态数据库（LSDB）用来保存当前网络拓扑结构，路由器上属于同一区域的链路状态数据库是相同的（属于多个区域的路由器会为每个区域维护一份链路状态数据库）。

OSPF提出了“区域（Area）”的概念，一个网络可以由单一区域或者多个区域组成。其中，一个特别的区域被称为骨干区域（Backbone Area），该区域是整个OSPF网络的核心区域，并且所有其他的区域都与之直接连接。所有的内部路由都通过骨干区域传递到其他非骨干区域。所有的区域都必须直接连接到骨干区域，如果不能建立直接连接，那么可以通过虚链路（virtual link）和骨干区域建立虚拟连接。

同一个广播域（Broadcast Domain）的路由器或者一个点对点（Point To Point）连接的两端的路由器，在发现彼此的时候，建立邻接（Adjacencies）多路访问网络以及非广播多路访问网络的路由器会选举指定路由器（Designated Router, DR）和备份指定路由器（Backup Designated Router, BDR），DR和BDR作为网络的中心负责路由器之间的信息交换从而降低了网络中的信息流量。OSPF协议同时使用单播（Unicast）和群播（Multicast）来发送Hello包和链路状态更新（Link State Updates），使用的群播地址为224.0.0.5和224.0.0.6。与RIP和BGP不同的是，OSPF协议不使用TCP或者UDP协议而是直接承载在IP协议之上，IP协议号为89。

区域是以接口（Interface）为单位来划分的，所以一台多接口路由器可能属于多个区域。相同区域内的所有路由器都维护一份相同的链路状态数据库（LSDB），如果一台路由器属于多个区域，那么它将为每一个区域维护一份LSDB。 将一个网络划分为多个区域有以下优点：

    某一区域内的路由器只需要维护该区域的链路状态数据库，而不用维护整个OSPF网络的链路状态数据库。
    将某一区域网络拓扑变化的影响限制在该区域内，不会影响到整个OSPF网络，从而减小OSPF计算的频率。
    将链路状态通告（LSA）的洪泛限制在本区域内，从而降低OSPF协议产生的数据量。
    划分区域可以对网络进行层次化结构设计。
    划分区域有利于资源合理调配，核心区域部署性能较好的设备资源，边缘区域部署性能较差的设备资源即可。


OSPF定义了以下4种网络类型：[1]

    点到点网络（point-to-point）
    广播网络（broadcast）
    非广播多路访问网络（non-broadcast multi-access，NBMA）
    点到多点网络（Point-to-MultiPoint）

点到点网络

点到点网络，例如E1、SONET，是单独连接一对路由器的网络。点到点网络上的一对OSPF路由器形成完全邻接关系（Full Adjacency），并且不进行DR和BDR的选举。点到点网络上的路由器使用群播地址224.0.0.5发送OSPF协议数据包。
广播网络

广播网络即可以同时连接多于两台设备的网络，如以太网、令牌环网、FDDI。广播网络上的路由器发送的群播/广播数据包会被其他与之相连的路由器收到。在广播网络上的OSPF路由器会选举一台指定路由器（DR）和一台备份指定路由器（BDR）。所有始发于DR和BDR的OSPF数据包使用目的地址224.0.0.5，以群播方式发送到所有其他OSPF路由器，所有其他的路由器都将使用目的地址224.0.0.6，以群播方式发送OSPF数据包到DR和BDR。所有其他的路由器只与DR和BDR建立完全邻接关系。
非广播多路访问网络

NBMA网络，诸如X.25、帧中继、ATM等，可以同时连接两台以上的路由器，但是这种网络没有广播数据包的能力。一台处于NBMA网络上的路由器发送的群播/广播数据包将不能被其他与之相连的路由器收到。在NBMA网络上需要选举DR和BDR，并且所有的OSPF数据包都是单播发送的。
点到多点网络
点到多点网络是NBMA网络的一个特殊设置，可以看作是一群点到点链路的集合，因此在该种网络上不必选举DR和BDR。点到多点网络上OSPF的行为和点到点网络OSPF的行为一样，也使用群播地址224.0.0.5发送OSPF协议数据包。


在OSPF路由器之间互相交换信息之前，必须先建立邻接关系。

两台OSPF路由器要建立完全邻接关系，以下参数必须相同：

    Hello时间间隔
    Dead时间间隔
    区域编号
    认证（如果启用了认证）
    链路MTU大小
    子网掩码
    子网号
    末梢区域设置

一般来说，建立OSPF完全邻接时会经过以下状态：

    失效状态（Down）：这是邻居会话的初始状态，表示最近没有从邻居收到信息。在NBMA网络上，可能仍然会以较低频率向处于Down状态的邻居发送Hello数据包。
    尝试状态（Attempt）：该状态仅仅适用于连接在NBMA网络上的邻居。该状态表示最近没有从邻居收到信息，但仍需要作进一步的尝试，来联系邻居。这时按某一特定间隔向邻居发送Hello数据包。
    初始状态（Init）:在此状态下，表示最近收到了从邻居发来的Hello数据包。但是，仍然没有和邻居建立双向通信（Bidirectional Communication），例如，路由器自身并没有出现在邻居发送的Hello数据包中。
    双向通信状态（2-Way）：此状态意味着两台路由器之间建立了双向通信。在此状态下还将进行DR和BDR的选举（只有处于2-Way状态的路由器才有资格参选DR和BDR）
    信息交换初始状态（ExStart）：这个状态是建立邻接关系的第一步。该状态的目标是决定信息交换时路由器的主从关系，并确定初始数据库描述（DD）数据包的序列号。具有最高路由器ID的路由器将成为主路由器。
    信息交换状态（ExChange）：在此状态的路由器通过向邻居发送DD数据包来描述其完整的链路状态数据库。每一个DD数据包都有一个序列号，并且需要被显式的确认。在任何时候，每次只能发送一个DD数据包。在此状态下，路由器也可以发送链路状态请求数据包，用来向邻居请求最新的LSA。实际上，这些状态的邻接关系完全有能力发送和接收所有类型的OSPF协议数据包。
    信息加载状态（Loading）：在此状态下，路由器将会向邻居路由器发送链路状态请求数据包，用来请求信息交换状态发现的最新的LSA。
    完全邻接状态（Full）：在此状态下，邻居路由器形成完全邻接关系。这些邻接关系将会在路由器LSA和网络LSA中被描述。

Hello包Hello包的OSPF包类型为1。这些包被周期性的从各个接口（包括虚链路）发出，用来建立和维护邻居关系。另外，在支持群播或广播的物理网络上，Hello包使用群播地址（通常为224.0.0.5)发送。 Hello包的发送间隔由HelloInterval指定（通常为10s），路由器将会先发出不包含邻居字段的空Hello包，当收到邻接路由器的Hello包之后，将对方的路由器标识放入本机的Hello包中进行群播，这种包含邻居字段的包，也被称为HelloSeen包。假如在间隔达到RouterDeadInterval所规定的时长（通常为40s）内仍未收到一个已建立连接的路由器的Hello包，路由器将会终止这一连接。将对方的状态转为Down。
