# Raft成员变更

> **Note** :脑裂，指多个领导者的情况。

成员变更时,最大的风险是可能出现两个领导者:

比如在进行成员变更时,节点A、B、C 之间发生了分区错误,节点 A、B 组成旧配置中"大多数",也就是变更前的 3 节点集群中的“大多数”,那么这时的领导者(节点 A)依旧是领导者。

另一方面,节点 C 和新节点 D、E 组成了新配置的"大多数",也就是变更后的 5 节点集群中的"大多数",它们可能会选举出新的领导者(比如节点 C)。那么这时,就出现了同时存在 2 个领导者的情况。

## 解决方法： 单节点变更

单节点变更,就是通过一次变更一个节点实现成员变更。如果需要变更多个节点,那你需要执行多次单节点变更。比如将3 节点集群扩容为 5 节点集群,这时你需要执行 2 次单节点变更,先将 3 节点集群变更为 4 节点集群,然后再将 4 节点集群变更为 5 节点集群。

### 过程

假定 A 是领导者:

目前的集群配置为 [A, B, C],我们先向集群中加入节点 D,这意味着新配置为 [A, B, C,D]。成员变更,是通过这么两步实现的:

1. 领导者（节点A）向新节点（节点D）同步数据；

2. 领导者（节点A）将新配置[A,B,C,D]作为一个日志项，复制到新配置中所有节点（A,B,C,D）上，然后将新配置的日志项提交到本地状态机，完成单节点变更。

在正常情况下,不管旧的集群配置是怎么组成的,旧配置的“大多数”和新配置的“大多数”都会有一个节点是重叠的。也就是说,不会同时存在旧配置和新配置 2 个“大多数”:

分区错误、节点故障等情况下,如果我们并发执行单节点变更,那么就可能出现一次单节点变更尚未完成,新的单节点变更又在执行,导致集群出现 2 个领导者的情况。


