# Address Sanitizer

Shadow Memory机制，Redzone机制。

## Shadow Memory

它是一块专门的内存区域，用来记录应用程序内存的可用状态。具体来说，ASan将应用程序的每8字节内存映射到1字节的影子内存，该影子字节的值表示对应8字节应用程序内存的状态。

在64位系统中，ASan将虚拟地址空间划分为两个部分：

1. 主应用程序内存（Application Memory）：用于正常程序执行。
2. 影子内存（Shadow Memory）：用于存储主内存的状态。

每个影子字节对应8字节的应用程序内存，影子字节的值表示这8字节中哪些字节是可寻址的（即可以安全访问）。具体含义如下：

0：表示对应的8字节全部可访问。
1~7：表示前k个字节可访问，其余不可访问（用于处理部分可访问的情况，比如结构体末尾的填充）。
负数（通常为0xFA、0xFB等）：表示不可访问，用于红区（redzone）或已释放内存。

### 如何检测内存出错？

1. 堆缓冲区溢出

当分配堆内存时，ASan会在分配的内存块前后添加红区（redzone），并将红区对应的影子内存标记为不可访问（例如0xF1、0xF2）。如果程序访问了红区，ASan会检查影子内存，发现该地址对应的影子字节为非0，从而报告错误。

2.  栈缓冲区溢出

ASan在栈上分配变量时，也会在变量之间插入红区，并将红区对应的影子内存标记为不可访问。

3. 使用已释放内存

当释放堆内存时，ASan会将整个内存块（包括红区）标记为不可访问（影子字节设置为0xF3）。如果程序访问已释放的内存，ASan会检查影子内存，发现该地址对应的影子字节为0xF3，从而报告use-after-free错误。

4. 双重释放

释放内存时，ASan会检查该内存块是否已经被释放（通过检查影子内存的标志），如果已经被释放，则报告双重释放错误。

## Redzone

红区是ASan在内存分配周围添加的不可访问区域，用于检测越界访问。红区的大小根据分配类型有所不同：

- 堆分配：通常左右各16字节的红区。
- 栈分配：根据变量大小和栈帧布局，红区大小可能不同。

ASan的性能开销主要来自：

- 内存访问的插桩检查：每个内存访问都需要检查影子内存，导致CPU开销增加约1.5-2倍。
- 内存开销：影子内存占用约1/8的应用程序内存，加上红区，总内存开销约增加2-3倍。


