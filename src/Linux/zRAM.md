# 什么是zRAM?

Linux Kernel提供了swap机制能够在内存不足的时候把进程不常用的内存放入到磁盘中，然后将这些内存归还给系统，系统可以将这些内存继续分配给其他需要使用内存的进程。

通过 swap 机制，系统可以将内存分配给需求更迫切的进程。但由于 swap 机制需要进行 I/O 操作，所以一定程度上会影响系统性能。那么是否存在一种能够节省内存，而且对性能影响较少的机制呢？

## zRAM原理

将进程不常用的内存压缩存储，从而达到节省内存的使用。

zRAM 机制建立在 swap 机制之上，swap 机制是将进程不常用的内存交换到磁盘中，而 zRAM 机制是将进程不常用的内存压缩存储在内存某个区域。所以 zRAM 机制并不会发生 I/O 操作，从而避免因 I/O 操作导致的性能下降。

由于 zRAM 机制是建立在 swap 机制之上，而 swap 机制需要配置 文件系统 或 块设备 来完成的。所以 zRAM 虚拟一个块设备，当系统内存不足时，swap 机制将内存写入到这个虚拟的块设备中。也就是说，zRAM 机制本质上只是一个虚拟块设备。

当内存不足的时候，内核会：
1. 通过swap机制从系统中查找一些进程不常用的内存。
2. 将这些不常用的内存交换到zRA块设备中，而zRAM块设备会先对这些不常用的内存进行压缩，然后存储起来。
3. 把不常用的内存压缩存储到zRAM块设备后,swap机制会把这些不常用的内存归还给内核。
4. 当进程访问到这些被交换到zRAM块设备的内存时，swap机制将会通过zRAM块内存解压这些内存，并且重新建立与进程的地址映射关系。

## zRAM实现

代码在drivers/block/zram/zram_drv.c的部分

### 压缩内存

当系统内存不足时，内核将会触发swaph机制，swap机制首先会从系统中选择一些进程不常用内存，然后将这些不常用的内存交换到zRAM块设备中（使用zRAM块设备作为交换设备）。

当swap机制将不常用的内存交换到zRAM块设备时，会调用zram_make_request()函数处理请求。而zram_make_request()最终会调用zram_bvec_write()函数来压缩内存。

大致步骤：

1. 获取需要进行压缩的内存，需要进行压缩的内存由 swap 机制提供。
2. 通过 zcomp_compress() 函数对内存进行压缩，src 指针指向压缩后的内存地址。
3. 通过 zs_malloc() 和 zs_map_object() 函数申请一块新的内存块，大小为压缩后数据的大小。
4. 将压缩后的数据复制到新申请的内存块中。
5. 将压缩后的数据记录到 zRAM 块设备的表格中。
